<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário Auditoria de Contas Médicas - CaptaMed</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cor-primaria: #006666;
            --cor-primaria-escuro: #004d4d;
            --cor-secundaria: #4a9b9b;
            --cor-destaque: #CD3333;
            --cor-fundo: #f0f4f4;
            --cor-texto: #333333;
            --cor-borda: #b8d4d4;
            --cor-sucesso: #2e7d32;
            --cor-info: #1976d2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--cor-fundo) 0%, #e8f2f2 100%);
            padding: 20px;
            color: var(--cor-texto);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 77, 77, 0.15);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 4px solid var(--cor-primaria);
            padding-bottom: 20px;
            background: linear-gradient(135deg, rgba(0, 102, 102, 0.05) 0%, rgba(74, 155, 155, 0.05) 100%);
            border-radius: 8px;
            padding: 20px;
        }

        .header h1 {
            color: var(--cor-primaria);
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header-subtitle {
            color: var(--cor-secundaria);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .section {
            margin-bottom: 40px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--cor-borda);
        }

        .section-title {
            background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-secundaria) 100%);
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .section-title:hover {
            background: linear-gradient(135deg, var(--cor-secundaria) 0%, var(--cor-primaria) 100%);
            box-shadow: 0 2px 8px rgba(0, 77, 77, 0.2);
        }

        .section-toggle {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 20px;
            background-color: #fafbfb;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .section-content.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        .input-field label {
            font-weight: 600;
            color: var(--cor-primaria);
            margin-bottom: 6px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field input,
        .input-field select,
        .input-field textarea {
            padding: 10px 12px;
            border: 2px solid var(--cor-borda);
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
            background-color: white;
        }

        .input-field input:focus,
        .input-field select:focus,
        .input-field textarea:focus {
            outline: none;
            border-color: var(--cor-secundaria);
            box-shadow: 0 0 0 3px rgba(74, 155, 155, 0.1);
            background-color: #f9fefe;
        }

        .input-field textarea {
            resize: vertical;
            min-height: 100px;
        }

        .input-field.required label::after {
            content: " *";
            color: var(--cor-destaque);
            font-weight: 700;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: white;
            border: 2px solid var(--cor-borda);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            background-color: rgba(74, 155, 155, 0.05);
            border-color: var(--cor-secundaria);
        }

        .radio-item input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--cor-primaria);
        }

        .radio-item label {
            cursor: pointer;
            margin: 0;
            font-weight: 500;
            font-size: 14px;
        }

        .item-section {
            background-color: white;
            border: 2px solid var(--cor-borda);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .item-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--cor-borda);
        }

        .item-section-title {
            font-weight: 700;
            color: var(--cor-primaria);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-remove-item {
            background-color: var(--cor-destaque);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .btn-remove-item:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
        }

        .btn-add-item {
            background: linear-gradient(135deg, var(--cor-info) 0%, #0d47a1 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-add-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .items-container {
            margin-top: 20px;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 102, 102, 0.05) 0%, rgba(74, 155, 155, 0.05) 100%);
            border-radius: 8px;
            border-top: 2px solid var(--cor-borda);
        }

        button {
            padding: 14px 35px;
            font-size: 15px;
            font-weight: 700;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(-1px);
        }

        .btn-save {
            background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-secundaria) 100%);
            color: white;
        }

        .btn-save:hover {
            background: linear-gradient(135deg, var(--cor-secundaria) 0%, var(--cor-primaria) 100%);
        }

        .btn-print {
            background: linear-gradient(135deg, var(--cor-info) 0%, #0d47a1 100%);
            color: white;
        }

        .btn-print:hover {
            background: linear-gradient(135deg, #0d47a1 0%, var(--cor-info) 100%);
        }

        .btn-reset {
            background: linear-gradient(135deg, var(--cor-destaque) 0%, #b71c1c 100%);
            color: white;
        }

        .btn-reset:hover {
            background: linear-gradient(135deg, #b71c1c 0%, var(--cor-destaque) 100%);
        }

        .success-message {
            display: none;
            background: linear-gradient(135deg, var(--cor-sucesso) 0%, #1b5e20 100%);
            color: white;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid white;
            text-align: center;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .success-message.show {
            display: block;
            animation: slideIn 0.3s ease-in-out;
        }

        .error-message {
            display: none;
            background: linear-gradient(135deg, var(--cor-destaque) 0%, #b71c1c 100%);
            color: white;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid white;
            text-align: center;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
        }

        .error-message.show {
            display: block;
            animation: slideIn 0.3s ease-in-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media print {
            body {
                background-color: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
                max-width: 100%;
            }

            .buttons {
                display: none;
            }

            .btn-add-item,
            .btn-remove-item {
                display: none;
            }

            .success-message,
            .error-message {
                display: none;
            }

            .section-content {
                display: block !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 24px;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            button {
                padding: 12px 25px;
                font-size: 13px;
                width: 100%;
            }

            .buttons {
                flex-direction: column;
            }

            .item-section-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .btn-remove-item {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="success-message" id="successMessage">
            ✓ Formulário salvo com sucesso!
        </div>

        <div class="error-message" id="errorMessage">
            ✗ Por favor, preencha todos os campos obrigatórios!
        </div>

        <div class="header">
            <h1>AUDITORIA DE CONTAS MÉDICAS</h1>
            <p class="header-subtitle">CaptaMed - Sistema de Auditoria</p>
        </div>

        <!-- SEÇÃO DADOS DO PACIENTE/CONTA -->
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">
                <span>DADOS DO PACIENTE/CONTA</span>
                <span class="section-toggle">▶</span>
            </div>
            <div class="section-content active">
                <div class="input-row">
                    <div class="input-field required">
                        <label for="indicador">INDICADOR</label>
                        <select id="indicador" required>
                            <option value="">Selecione...</option>
                            <option value="Glosa">Glosa</option>
                            <option value="Recurso">Recurso</option>
                            <option value="Perda">Perda</option>
                            <option value="Adequação">Adequação</option>
                        </select>
                    </div>
                    <div class="input-field required">
                        <label for="paciente">PACIENTE</label>
                        <input type="text" id="paciente" placeholder="Nome do paciente" required>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-field required">
                        <label for="convenio">CONVÊNIO</label>
                        <select id="convenio" required>
                            <option value="">Selecione...</option>
                            <option value="AMMP">AMMP</option>
                            <option value="Aurora">Aurora</option>
                            <option value="Bacen">Bacen</option>
                            <option value="Cemig">Cemig</option>
                            <option value="Copass">Copass</option>
                            <option value="Desban">Desban</option>
                            <option value="IPSEMG">IPSEMG</option>
                            <option value="IPSM">IPSM</option>
                            <option value="Unafisco">Unafisco</option>
                            <option value="Usisaúde">Usisaúde</option>
                        </select>
                    </div>
                    <div class="input-field required">
                        <label for="numeroDoc">NÚMERO DO DOC</label>
                        <input type="text" id="numeroDoc" placeholder="Número do documento" required>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-field required">
                        <label for="dataPreenchimento">DATA DE PREENCHIMENTO</label>
                        <input type="text" id="dataPreenchimento" placeholder="Preenchida automaticamente" readonly>
                    </div>
                </div>

                <div class="input-field required" style="margin-bottom: 15px;">
                    <label style="text-align: center; display: block; margin-bottom: 12px;">PROGRAMA</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="ad" name="programa" value="AD" required>
                            <label for="ad">AD</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="id" name="programa" value="ID" required>
                            <label for="id">ID</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="tlp" name="programa" value="TLP" required>
                            <label for="tlp">TLP</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="gc" name="programa" value="GC" required>
                            <label for="gc">GC</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="ie" name="programa" value="IE" required>
                            <label for="ie">IE</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="cp" name="programa" value="CP" required>
                            <label for="cp">CP</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEÇÃO INFORMAÇÕES SOBRE O ITEM -->
        <div class="section">
            <div class="section-title" onclick="toggleSection(this)">
                <span>INFORMAÇÕES SOBRE O ITEM</span>
                <span class="section-toggle">▶</span>
            </div>
            <div class="section-content active">
                <div class="items-container" id="itemsContainer">
                    <!-- Itens serão adicionados aqui -->
                </div>
            </div>
        </div>

        <!-- BOTÃO ADICIONAR ITEM (FORA DA SEÇÃO) -->
        <button type="button" class="btn-add-item" onclick="adicionarItem()">+ Adicionar Item</button>

        <!-- BOTÕES -->
        <div class="buttons">
            <button type="button" class="btn-save" onclick="salvarFormulario()">Salvar</button>
            <button type="button" class="btn-print" onclick="imprimirFormulario()">Imprimir</button>
            <button type="button" class="btn-export" onclick="exportarCSV()" style="background-color: #4a9b9b;">Exportar CSV</button>
            <button type="button" class="btn-reset" onclick="limparFormulario()">Limpar</button>
        </div>
    </div>

    <script>
        // URL do Google Apps Script
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyVVy6FIRaukXyH6_EV9RkcU3QxBsliRDygZGMgFszpGeivER-mVB0hc47gD-M5XBFK/exec';
        
        let itemCount = 0;

        // Função para alternar seções
        function toggleSection(element) {
            const content = element.nextElementSibling;
            const toggle = element.querySelector('.section-toggle');
            
            content.classList.toggle('active');
            toggle.classList.toggle('collapsed');
        }

        // Função para adicionar novo item
        function adicionarItem() {
            itemCount++;
            const container = document.getElementById('itemsContainer');
            
            const itemHTML = `
                <div class="item-section" id="item-${itemCount}">
                    <div class="item-section-header">
                        <span class="item-section-title">ITEM ${itemCount}</span>
                        <button type="button" class="btn-remove-item" onclick="removerItem(${itemCount})">Remover Item</button>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-field required">
                            <label for="item-${itemCount}-descricao">DESCRIÇÃO DO ITEM</label>
                            <input type="text" id="item-${itemCount}-descricao" placeholder="Descrição do item" required>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-field required">
                            <label for="item-${itemCount}-setorResponsavel">SETOR RESPONSÁVEL</label>
                            <select id="item-${itemCount}-setorResponsavel" required>
                                <option value="">Selecione...</option>
                                <option value="Auditoria de Contas">Auditoria de Contas</option>
                                <option value="Equipe Médica">Equipe Médica</option>
                                <option value="Equipe Multi">Equipe Multi</option>
                                <option value="Filial - Brasília">Filial - Brasília</option>
                                <option value="Filial - Goiânia">Filial - Goiânia</option>
                                <option value="Filial - Ipatinga">Filial - Ipatinga</option>
                                <option value="Filial - Juiz de Fora">Filial - Juiz de Fora</option>
                                <option value="Filial - Norte de Minas">Filial - Norte de Minas</option>
                                <option value="Filial - Uberlândia">Filial - Uberlândia</option>
                                <option value="Filial - Vitória">Filial - Vitória</option>
                                <option value="Gerenciamento de Casos">Gerenciamento de Casos</option>
                                <option value="Internação AD/ID">Internação AD/ID</option>
                                <option value="Interior e Expansão">Interior e Expansão</option>
                                <option value="Parametrização">Parametrização</option>
                                <option value="Relacionamento e Comercial">Relacionamento e Comercial</option>
                                <option value="SAME">SAME</option>
                                <option value="Suporte Operacional">Suporte Operacional</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-field required" style="margin-bottom: 15px;">
                        <label for="item-${itemCount}-motivo">MOTIVO</label>
                        <textarea id="item-${itemCount}-motivo" placeholder="Justificativa da auditagem" required></textarea>
                    </div>

                    <div class="input-row">
                        <div class="input-field required">
                            <label for="item-${itemCount}-valorConta">VALOR CONTA (R$)</label>
                            <input type="number" id="item-${itemCount}-valorConta" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        <div class="input-field required">
                            <label for="item-${itemCount}-valorItem">VALOR ITEM (R$)</label>
                            <input type="number" id="item-${itemCount}-valorItem" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-field required">
                            <label for="item-${itemCount}-producaoMes">PRODUÇÃO (MÊS ATENDIMENTO)</label>
                            <input type="month" id="item-${itemCount}-producaoMes" required>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', itemHTML);
            salvarDados();
        }

        // Função para remover item
        function removerItem(id) {
            if (confirm('Tem certeza que deseja remover este item?')) {
                const item = document.getElementById(`item-${id}`);
                if (item) {
                    item.remove();
                    salvarDados();
                }
            }
        }

        // Função para validar campos obrigatórios
        function validarFormulario() {
            const campos = [
                'indicador',
                'paciente',
                'convenio',
                'numeroDoc'
            ];

            // Validar radio buttons - PROGRAMA é OPCIONAL
            // Removido: validação obrigatória do programa

            // Validar campos de texto
            for (let campo of campos) {
                const elemento = document.getElementById(campo);
                if (!elemento || !elemento.value.trim()) {
                    return false;
                }
            }

            // Validar itens
            const items = document.querySelectorAll('.item-section');
            if (items.length === 0) {
                return false;
            }

            for (let item of items) {
                const descricao = item.querySelector('[id*="-descricao"]');
                const setorResponsavel = item.querySelector('[id*="-setorResponsavel"]');
                const motivo = item.querySelector('[id*="-motivo"]');
                const valorConta = item.querySelector('[id*="-valorConta"]');
                const valorItem = item.querySelector('[id*="-valorItem"]');
                const producaoMes = item.querySelector('[id*="-producaoMes"]');

                if (!descricao?.value.trim()) return false;
                if (!setorResponsavel?.value) return false;
                if (!motivo?.value.trim()) return false;
                if (valorConta?.value === '' || valorConta?.value === null) return false;
                if (valorItem?.value === '' || valorItem?.value === null) return false;
                if (!producaoMes?.value) return false;
            }

            return true;
        }

        // Função para salvar dados no localStorage
        function salvarDados() {
            try {
                const items = [];
                document.querySelectorAll('.item-section').forEach((item, index) => {
                    try {
                        const descricao = item.querySelector('[id*="-descricao"]');
                        const setorResponsavel = item.querySelector('[id*="-setorResponsavel"]');
                        const motivo = item.querySelector('[id*="-motivo"]');
                        const valorConta = item.querySelector('[id*="-valorConta"]');
                        const valorItem = item.querySelector('[id*="-valorItem"]');
                        const producaoMes = item.querySelector('[id*="-producaoMes"]');

                        items.push({
                            descricao: descricao ? (descricao.value || '') : '',
                            setorResponsavel: setorResponsavel ? (setorResponsavel.value || '') : '',
                            motivo: motivo ? (motivo.value || '') : '',
                            valorConta: valorConta ? (valorConta.value || '') : '',
                            valorItem: valorItem ? (valorItem.value || '') : '',
                            producaoMes: producaoMes ? (producaoMes.value || '') : ''
                        });
                    } catch (e) {
                        console.error('Erro ao processar item:', e);
                    }
                });

                const indicador = document.getElementById('indicador');
                const paciente = document.getElementById('paciente');
                const convenio = document.getElementById('convenio');
                const numeroDoc = document.getElementById('numeroDoc');
                const dataPreenchimento = document.getElementById('dataPreenchimento');

                const formData = {
                    indicador: indicador ? (indicador.value || '') : '',
                    paciente: paciente ? (paciente.value || '') : '',
                    convenio: convenio ? (convenio.value || '') : '',
                    programa: document.querySelector('input[name="programa"]:checked')?.value || '',
                    numeroDoc: numeroDoc ? (numeroDoc.value || '') : '',
                    dataPreenchimento: dataPreenchimento ? (dataPreenchimento.value || '') : '',
                    items: items
                };

                localStorage.setItem('auditFormulario', JSON.stringify(formData));
            } catch (e) {
                console.error('Erro ao salvar dados:', e);
            }
        }

        // Função para preencher a data automaticamente
        function preencherDataAutomatica() {
            const dataAtual = new Date();
            const dataFormatada = dataAtual.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('dataPreenchimento').value = dataFormatada;
        }

        // Função para carregar dados do localStorage
        function carregarDados() {
            try {
                // Sempre adicionar o primeiro item PRIMEIRO
                adicionarItem();

                // Preencher data automaticamente
                preencherDataAutomatica();

                const formData = localStorage.getItem('auditFormulario');
                if (formData) {
                    try {
                        const dados = JSON.parse(formData);
                        
                        // Carregar dados principais com verificações de null
                        const indicador = document.getElementById('indicador');
                        const paciente = document.getElementById('paciente');
                        const convenio = document.getElementById('convenio');
                        const numeroDoc = document.getElementById('numeroDoc');

                        if (indicador) indicador.value = dados.indicador || '';
                        if (paciente) paciente.value = dados.paciente || '';
                        if (convenio) convenio.value = dados.convenio || '';
                        if (numeroDoc) numeroDoc.value = dados.numeroDoc || '';

                        if (dados.programa) {
                            const programaRadio = document.querySelector(`input[name="programa"][value="${dados.programa}"]`);
                            if (programaRadio) programaRadio.checked = true;
                        }

                        // Atualizar itens salvos
                        if (dados.items && Array.isArray(dados.items) && dados.items.length > 0) {
                            // Atualizar o primeiro item com os dados salvos
                            const firstItem = document.querySelector('.item-section:first-child');
                            if (firstItem && dados.items[0]) {
                                try {
                                    const desc = firstItem.querySelector('[id*="-descricao"]');
                                    const setor = firstItem.querySelector('[id*="-setorResponsavel"]');
                                    const mot = firstItem.querySelector('[id*="-motivo"]');
                                    const valConta = firstItem.querySelector('[id*="-valorConta"]');
                                    const valItem = firstItem.querySelector('[id*="-valorItem"]');
                                    const prod = firstItem.querySelector('[id*="-producaoMes"]');

                                    if (desc) desc.value = dados.items[0].descricao || '';
                                    if (setor) setor.value = dados.items[0].setorResponsavel || '';
                                    if (mot) mot.value = dados.items[0].motivo || '';
                                    if (valConta) valConta.value = dados.items[0].valorConta || '';
                                    if (valItem) valItem.value = dados.items[0].valorItem || '';
                                    if (prod) prod.value = dados.items[0].producaoMes || '';
                                } catch (e) {
                                    console.error('Erro ao carregar primeiro item:', e);
                                }
                            }

                            // Adicionar itens restantes (a partir do segundo)
                            for (let i = 1; i < dados.items.length; i++) {
                                const itemData = dados.items[i];
                                if (itemData) {
                                    adicionarItem();
                                    const lastItem = document.querySelector('.item-section:last-child');
                                    if (lastItem) {
                                        try {
                                            const desc = lastItem.querySelector('[id*="-descricao"]');
                                            const setor = lastItem.querySelector('[id*="-setorResponsavel"]');
                                            const mot = lastItem.querySelector('[id*="-motivo"]');
                                            const valConta = lastItem.querySelector('[id*="-valorConta"]');
                                            const valItem = lastItem.querySelector('[id*="-valorItem"]');
                                            const prod = lastItem.querySelector('[id*="-producaoMes"]');

                                            if (desc) desc.value = itemData.descricao || '';
                                            if (setor) setor.value = itemData.setorResponsavel || '';
                                            if (mot) mot.value = itemData.motivo || '';
                                            if (valConta) valConta.value = itemData.valorConta || '';
                                            if (valItem) valItem.value = itemData.valorItem || '';
                                            if (prod) prod.value = itemData.producaoMes || '';
                                        } catch (e) {
                                            console.error('Erro ao carregar item', i, ':', e);
                                        }
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Erro ao fazer parse dos dados salvos:', e);
                    }
                }
            } catch (e) {
                console.error('Erro geral em carregarDados:', e);
            }
        }

        // Função para salvar formulário
        function salvarFormulario() {
            // Se a URL do Google Apps Script está configurada, enviar para lá
            if (GOOGLE_APPS_SCRIPT_URL !== 'SEU_LINK_AQUI') {
                enviarParaGoogleSheets();
            } else {
                // Se não, apenas salvar localmente
                if (!validarFormulario()) {
                    mostrarMensagem('error');
                    return;
                }

                salvarDados();
                mostrarMensagem('success');

                // Limpar mensagem após 3 segundos
                setTimeout(() => {
                    document.getElementById('successMessage').classList.remove('show');
                }, 3000);
            }
        }

        // Função para imprimir formulário
        function imprimirFormulario() {
            if (!validarFormulario()) {
                mostrarMensagem('error');
                return;
            }

            window.print();
        }

        // Função para limpar formulário
        function limparFormulario() {
            if (confirm('Tem certeza que deseja limpar todos os dados? Esta ação não pode ser desfeita.')) {
                document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="month"], textarea, select').forEach(el => {
                    el.value = '';
                });
                document.querySelectorAll('input[type="radio"]').forEach(el => {
                    el.checked = false;
                });
            document.getElementById('itemsContainer').innerHTML = '';
            itemCount = 0;
            localStorage.removeItem('auditFormulario');
            // Recarregar a página para reiniciar com um item vazio
            location.reload();
            }
        }

        // Função para mostrar mensagens
        function mostrarMensagem(tipo) {
            const successMsg = document.getElementById('successMessage');
            const errorMsg = document.getElementById('errorMessage');

            if (tipo === 'success') {
                successMsg.classList.add('show');
                errorMsg.classList.remove('show');
            } else {
                errorMsg.classList.add('show');
                successMsg.classList.remove('show');
            }
        }

        // Função para exportar dados em CSV
        function exportarCSV() {
            const formData = localStorage.getItem('auditFormulario');
            if (!formData) {
                alert('Nenhum dado salvo para exportar!');
                return;
            }

            const dados = JSON.parse(formData);
            let csv = 'Data de Preenchimento,Indicador,Paciente,Convênio,Programa,Número DOC,Descrição Item,Setor Responsável,Motivo,Valor Conta,Valor Item,Produção\n';

            if (dados.items && dados.items.length > 0) {
                dados.items.forEach(item => {
                    const linha = [
                        `"${dados.dataPreenchimento}"`,
                        `"${dados.indicador}"`,
                        `"${dados.paciente}"`,
                        `"${dados.convenio}"`,
                        `"${dados.programa}"`,
                        `"${dados.numeroDoc}"`,
                        `"${item.descricao}"`,
                        `"${item.setorResponsavel}"`,
                        `"${item.motivo}"`,
                        `"${item.valorConta}"`,
                        `"${item.valorItem}"`,
                        `"${item.producaoMes}"`
                    ].join(',');
                    csv += linha + '\n';
                });
            }

            // Criar blob e fazer download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `auditoria_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('Arquivo CSV exportado com sucesso!');
        }

        // Função para enviar dados ao Google Sheets
        async function enviarParaGoogleSheets() {
            if (!validarFormulario()) {
                mostrarMensagem('error');
                return;
            }

            // Coletar todos os dados do formulário
            const items = [];
            document.querySelectorAll('.item-section').forEach((item) => {
                const descricao = item.querySelector('[id*="-descricao"]');
                const setorResponsavel = item.querySelector('[id*="-setorResponsavel"]');
                const motivo = item.querySelector('[id*="-motivo"]');
                const valorConta = item.querySelector('[id*="-valorConta"]');
                const valorItem = item.querySelector('[id*="-valorItem"]');
                const producaoMes = item.querySelector('[id*="-producaoMes"]');

                items.push({
                    descricao: descricao ? descricao.value : '',
                    setorResponsavel: setorResponsavel ? setorResponsavel.value : '',
                    motivo: motivo ? motivo.value : '',
                    valorConta: valorConta ? valorConta.value : '',
                    valorItem: valorItem ? valorItem.value : '',
                    producaoMes: producaoMes ? producaoMes.value : ''
                });
            });

            const formData = {
                indicador: document.getElementById('indicador').value,
                paciente: document.getElementById('paciente').value,
                convenio: document.getElementById('convenio').value,
                programa: document.querySelector('input[name="programa"]:checked')?.value || '',
                numeroDoc: document.getElementById('numeroDoc').value,
                dataPreenchimento: document.getElementById('dataPreenchimento').value,
                items: items
            };

            try {
                // Mostrar indicador de carregamento
                const btnSalvar = document.querySelector('.btn-save');
                const textoOriginal = btnSalvar.textContent;
                btnSalvar.textContent = 'Enviando...';
                btnSalvar.disabled = true;

                // Enviar dados para o Google Apps Script
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                // Salvar localmente também
                salvarDados();

                // Mostrar mensagem de sucesso
                mostrarMensagem('success');
                
                // Restaurar botão
                btnSalvar.textContent = textoOriginal;
                btnSalvar.disabled = false;

                // Limpar mensagem após 3 segundos
                setTimeout(() => {
                    document.getElementById('successMessage').classList.remove('show');
                }, 3000);

            } catch (error) {
                console.error('Erro ao enviar dados:', error);
                alert('Erro ao enviar dados para o Google Sheets. Os dados foram salvos localmente.');
                
                // Salvar localmente em caso de erro
                salvarDados();
                
                // Restaurar botão
                const btnSalvar = document.querySelector('.btn-save');
                btnSalvar.textContent = 'Salvar';
                btnSalvar.disabled = false;
            }
        }

        // Auto-save a cada 30 segundos
        setInterval(salvarDados, 30000);

        // Carregar dados ao abrir a página
        window.addEventListener('load', carregarDados);
    </script>
</body>
</html>
